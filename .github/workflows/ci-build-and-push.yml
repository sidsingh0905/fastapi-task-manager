name: CI - Build, Lint, Test & Push to ECR

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-1
  ECR_REPO: fast-api-todo-ecr-repo
  APP_DIR: fast-api-todo-app

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout your repo code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS credentials using OIDC
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_GITHUB_OIDC_ROLE_ARN }}

      # 3ï¸âƒ£ Login to ECR
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4ï¸âƒ£ Setup Python (same version as your Dockerfile)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 5ï¸âƒ£ Cache pip dependencies for faster builds
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 6ï¸âƒ£ Install dependencies and lint/test tools
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8 pytest

      # 7ï¸âƒ£ Lint your code for quality
      - name: Lint code
        run: flake8 app --max-line-length=120

    #   # 8ï¸âƒ£ Run tests (you can skip if you donâ€™t have tests yet)
    #   - name: Run unit tests
    #     run: pytest -q || exit 1

      # 9ï¸âƒ£ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${{ github.sha }} -f Dockerfile .

      # ðŸ”Ÿ Push image to ECR
      - name: Push image to ECR
        run: |
          docker push ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${{ github.sha }}
          docker tag ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${{ github.sha }} \
            ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:latest
          docker push ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:latest

      # 1ï¸âƒ£1ï¸âƒ£ Output image URI
      - name: Output image URI
        run: echo "IMAGE_URI=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${{ github.sha }}" >> $GITHUB_ENV
